function regexMap(r,e,t){for(;null!=(result=r.exec(e));)t(result)}function Shader(r,e){function t(r){var e=document.getElementById(r);return e?e.text:r}function a(r,e){var t={},a=/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/.exec(e);return e=a?a[1]+r+e.substr(a[1].length):r+e,regexMap(/\bgl_\w+\b/g,r,function(r){r in t||(e=e.replace(new RegExp("\\b"+r+"\\b","g"),LIGHTGL_PREFIX+r),t[r]=!0)}),e}function i(r,e){var t=gl.createShader(r);if(gl.shaderSource(t,e),gl.compileShader(t),!gl.getShaderParameter(t,gl.COMPILE_STATUS))throw"compile error: "+gl.getShaderInfoLog(t);return t}r=t(r),e=t(e);var o="    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",n=o+"    attribute vec4 gl_Vertex;    attribute vec4 gl_TexCoord;    attribute vec3 gl_Normal;    attribute vec4 gl_Color;    vec4 ftransform() {      return gl_ModelViewProjectionMatrix * gl_Vertex;    }  ",l="    precision highp float;  "+o,f=r+e,g={};if(regexMap(/\b(gl_[^;]*)\b;/g,o,function(r){var e=r[1];if(-1!=f.indexOf(e)){var t=e.replace(/[a-z_]/g,"");g[t]=LIGHTGL_PREFIX+e}}),-1!=f.indexOf("ftransform")&&(g.MVPM=LIGHTGL_PREFIX+"gl_ModelViewProjectionMatrix"),this.usedMatrices=g,r=a(n,r),e=a(l,e),this.program=gl.createProgram(),gl.attachShader(this.program,i(gl.VERTEX_SHADER,r)),gl.attachShader(this.program,i(gl.FRAGMENT_SHADER,e)),gl.linkProgram(this.program),!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw"link error: "+gl.getProgramInfoLog(this.program);this.attributes={},this.uniformLocations={};var s={};regexMap(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,r+e,function(r){s[r[2]]=1}),this.isSampler=s}function isArray(r){var e=Object.prototype.toString.call(r);return"[object Array]"==e||"[object Float32Array]"==e}function isNumber(r){var e=Object.prototype.toString.call(r);return"[object Number]"==e||"[object Boolean]"==e}var LIGHTGL_PREFIX="LIGHTGL",tempMatrix=new Matrix,resultMatrix=new Matrix;Shader.prototype={uniforms:function(r){gl.useProgram(this.program);for(var e in r){var t=this.uniformLocations[e]||gl.getUniformLocation(this.program,e);if(t){this.uniformLocations[e]=t;var a=r[e];if(a instanceof Vector?a=[a.x,a.y,a.z]:a instanceof Matrix&&(a=a.m),isArray(a))switch(a.length){case 1:gl.uniform1fv(t,new Float32Array(a));break;case 2:gl.uniform2fv(t,new Float32Array(a));break;case 3:gl.uniform3fv(t,new Float32Array(a));break;case 4:gl.uniform4fv(t,new Float32Array(a));break;case 9:gl.uniformMatrix3fv(t,!1,new Float32Array([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]));break;case 16:gl.uniformMatrix4fv(t,!1,new Float32Array([a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]));break;default:throw"don't know how to load uniform \""+e+'" of length '+a.length}else{if(!isNumber(a))throw'attempted to set uniform "'+e+'" to invalid value '+a;(this.isSampler[e]?gl.uniform1i:gl.uniform1f).call(gl,t,a)}}}return this},drawSymbol:function(r){r.mesh.texture.bind(0);var e=4*r.indexInCollection,t=new Buffer(gl.ELEMENT_ARRAY_BUFFER,Uint16Array);t.data=[],t.data.push([e,e+1,e+2]),t.data.push([e+2,e+1,e+3]),t.compile(),this.drawBuffers(r.mesh.vertexBuffers,t,gl.TRIANGLES),gl.deleteBuffer(t.buffer)},drawSymbols:function(r){this.drawBuffers(r.vertexBuffers,r.indexBuffers.triangles,gl.TRIANGLES)},draw:function(r,e){this.drawBuffers(r.vertexBuffers,r.indexBuffers[e==gl.LINES?"lines":"triangles"],arguments.length<2||null==e?gl.TRIANGLES:e)},drawBuffers:function(r,e,t){var a=this.usedMatrices,i=gl.modelviewMatrix,o=gl.projectionMatrix,n=a.MVMI||a.NM?i.inverse():null,l=a.PMI?o.inverse():null,f=a.MVPM||a.MVPMI?o.multiply(i):null,g={};if(a.MVM&&(g[a.MVM]=i),a.MVMI&&(g[a.MVMI]=n),a.PM&&(g[a.PM]=o),a.PMI&&(g[a.PMI]=l),a.MVPM&&(g[a.MVPM]=f),a.MVPMI&&(g[a.MVPMI]=f.inverse()),a.NM){var s=n.m;g[a.NM]=[s[0],s[4],s[8],s[1],s[5],s[9],s[2],s[6],s[10]]}this.uniforms(g);var u=0;for(var m in r){var c=r[m],M=this.attributes[m]||gl.getAttribLocation(this.program,m.replace(/^(gl_.*)$/,LIGHTGL_PREFIX+"$1"));-1!=M&&c.buffer&&(this.attributes[m]=M,gl.bindBuffer(gl.ARRAY_BUFFER,c.buffer),gl.enableVertexAttribArray(M),gl.vertexAttribPointer(M,c.buffer.spacing,gl.FLOAT,!1,0,0),u=c.buffer.length/c.buffer.spacing)}for(var m in this.attributes)m in r||gl.disableVertexAttribArray(this.attributes[m]);return!u||e&&!e.buffer||(e?(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.buffer),gl.drawElements(t,e.buffer.length,gl.UNSIGNED_SHORT,0)):gl.drawArrays(t,0,u)),this}};