function addMatrixStack(){gl.MODELVIEW=1|ENUM,gl.PROJECTION=2|ENUM;var e=new Matrix,t=new Matrix;gl.modelviewMatrix=new Matrix,gl.projectionMatrix=new Matrix;var o,n,r=[],a=[];gl.matrixMode=function(e){switch(e){case gl.MODELVIEW:o="modelviewMatrix",n=r;break;case gl.PROJECTION:o="projectionMatrix",n=a;break;default:throw"invalid matrix mode "+e}},gl.loadIdentity=function(){Matrix.identity(gl[o])},gl.loadMatrix=function(e){for(var t=e.m,n=gl[o].m,r=0;16>r;r++)n[r]=t[r]},gl.multMatrix=function(e){gl.loadMatrix(Matrix.multiply(gl[o],e,t))},gl.perspective=function(t,o,n,r){gl.multMatrix(Matrix.perspective(t,o,n,r,e))},gl.frustum=function(t,o,n,r,a,i){gl.multMatrix(Matrix.frustum(t,o,n,r,a,i,e))},gl.ortho=function(t,o,n,r,a,i){gl.multMatrix(Matrix.ortho(t,o,n,r,a,i,e))},gl.scale=function(t,o,n){gl.multMatrix(Matrix.scale(t,o,n,e))},gl.translate=function(t,o,n){gl.multMatrix(Matrix.translate(t,o,n,e))},gl.rotate=function(t,o,n,r){gl.multMatrix(Matrix.rotate(t,o,n,r,e))},gl.lookAt=function(t,o,n,r,a,i,l,g,u){gl.multMatrix(Matrix.lookAt(t,o,n,r,a,i,l,g,u,e))},gl.pushMatrix=function(){n.push(Array.prototype.slice.call(gl[o].m))},gl.popMatrix=function(){var e=n.pop();gl[o].m=hasFloat32Array?new Float32Array(e):e},gl.project=function(e,t,o,n,r,a){n=n||gl.modelviewMatrix,r=r||gl.projectionMatrix,a=a||gl.getParameter(gl.VIEWPORT);var i=r.transformPoint(n.transformPoint(new Vector(e,t,o)));return new Vector(a[0]+a[2]*(.5*i.x+.5),a[1]+a[3]*(.5*i.y+.5),.5*i.z+.5)},gl.unProject=function(o,n,r,a,i,l){a=a||gl.modelviewMatrix,i=i||gl.projectionMatrix,l=l||gl.getParameter(gl.VIEWPORT);var g=new Vector((o-l[0])/l[2]*2-1,(n-l[1])/l[3]*2-1,2*r-1);return Matrix.inverse(Matrix.multiply(i,a,e),t).transformPoint(g)},gl.matrixMode(gl.MODELVIEW)}function addImmediateMode(){var e={mesh:new Mesh({coords:!0,colors:!0,triangles:!1}),mode:-1,coord:[0,0,0,0],color:[1,1,1,1],pointSize:1,shader:new Shader("      uniform float pointSize;      varying vec4 color;      varying vec4 coord;      void main() {        color = gl_Color;        coord = gl_TexCoord;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;        gl_PointSize = pointSize;      }    ","      uniform sampler2D texture;      uniform float pointSize;      uniform bool useTexture;      varying vec4 color;      varying vec4 coord;      void main() {        gl_FragColor = color;        if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);      }    ")};gl.pointSize=function(t){e.shader.uniforms({pointSize:t})},gl.begin=function(t){if(-1!=e.mode)throw"mismatched gl.begin() and gl.end() calls";e.mode=t,e.mesh.colors=[],e.mesh.coords=[],e.mesh.vertices=[]},gl.color=function(t,o,n,r){e.color=1==arguments.length?t.toArray().concat(1):[t,o,n,r||1]},gl.texCoord=function(t,o){e.coord=1==arguments.length?t.toArray(2):[t,o]},gl.vertex=function(t,o,n){e.mesh.colors.push(e.color),e.mesh.coords.push(e.coord),e.mesh.vertices.push(1==arguments.length?t.toArray():[t,o,n])},gl.end=function(){if(-1==e.mode)throw"mismatched gl.begin() and gl.end() calls";e.mesh.compile(),e.shader.uniforms({useTexture:!!gl.getParameter(gl.TEXTURE_BINDING_2D)}).draw(e.mesh,e.mode),e.mode=-1}}function addEventListeners(){function e(){for(var e in c)if(s.call(c,e)&&c[e])return!0;return!1}function t(t){var o={};for(var n in t)o[n]="function"==typeof t[n]?function(e){return function(){e.apply(t,arguments)}}(t[n]):t[n];o.original=t,o.x=o.pageX,o.y=o.pageY;for(var r=gl.canvas;r;r=r.offsetParent)o.x-=r.offsetLeft,o.y-=r.offsetTop;return d?(o.deltaX=o.x-g,o.deltaY=o.y-u):(o.deltaX=0,o.deltaY=0,d=!0),g=o.x,u=o.y,o.dragging=e(),o.preventDefault=function(){o.original.preventDefault()},o.stopPropagation=function(){o.original.stopPropagation()},o}function o(o){gl=l,e()||(GL.on(document,"mousemove",n),GL.on(document,"mouseup",r),GL.off(gl.canvas,"mousemove",n),GL.off(gl.canvas,"mouseup",r)),c[o.which]=!0,o=t(o),gl.onmousedown&&gl.onmousedown(o),o.preventDefault()}function n(e){gl=l,e=t(e),gl.onmousemove&&gl.onmousemove(e),e.preventDefault()}function r(o){gl=l,c[o.which]=!1,e()||(GL.off(document,"mousemove",n),GL.off(document,"mouseup",r),GL.on(gl.canvas,"mousemove",n),GL.on(gl.canvas,"mouseup",r)),o=t(o),gl.onmouseup&&gl.onmouseup(o),o.preventDefault()}function a(){d=!1}function i(){c={},d=!1}var l=gl,g=0,u=0,c={},d=!1,s=Object.prototype.hasOwnProperty;GL.on(gl.canvas,"mousedown",o),GL.on(gl.canvas,"mousemove",n),GL.on(gl.canvas,"mouseup",r),GL.on(gl.canvas,"mouseover",a),GL.on(gl.canvas,"mouseout",a),GL.on(document,"contextmenu",i)}function mapKeyCode(e){var t={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return t[e]||(e>=65&&90>=e?String.fromCharCode(e):null)}function addOtherMethods(){!function(e){gl.makeCurrent=function(){gl=e}}(gl),gl.animate=function(){function e(){gl=n;var r=(new Date).getTime();gl.onupdate&&gl.onupdate((r-o)/1e3),gl.ondraw&&gl.ondraw(),t(e),o=r}var t=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},o=(new Date).getTime(),n=gl;e()},gl.fullscreen=function(e){function t(){gl.canvas.width=window.innerWidth-n-r,gl.canvas.height=window.innerHeight-o-a,gl.viewport(0,0,gl.canvas.width,gl.canvas.height),!e.camera&&"camera"in e||(gl.matrixMode(gl.PROJECTION),gl.loadIdentity(),gl.perspective(e.fov||45,gl.canvas.width/gl.canvas.height,e.near||.1,e.far||1e3),gl.matrixMode(gl.MODELVIEW)),gl.ondraw&&gl.ondraw()}e=e||{};var o=e.paddingTop||0,n=e.paddingLeft||0,r=e.paddingRight||0,a=e.paddingBottom||0;if(!document.body)throw"document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)";document.body.appendChild(gl.canvas),document.body.style.overflow="hidden",gl.canvas.style.position="absolute",gl.canvas.style.left=n+"px",gl.canvas.style.top=o+"px",GL.on(window,"resize",t),t()}}var gl,GL={create:function(e,t){t=t||{};var o=null;null==e?(o=document.createElement("canvas"),o.width=200,o.height=200):o=e,"alpha"in t||(t.alpha=!1);try{gl=o.getContext("webgl",t)}catch(n){}try{gl=gl||o.getContext("experimental-webgl",t)}catch(n){}if(!gl)throw"WebGL not supported";return addMatrixStack(),addImmediateMode(),addOtherMethods(),gl},keys:{},Matrix:Matrix,Indexer:Indexer,Buffer:Buffer,Mesh:Mesh,HitTest:HitTest,Raytracer:Raytracer,Shader:Shader,Texture:Texture,Vector:Vector};GL.on=function(e,t,o){e.addEventListener(t,o)},GL.off=function(e,t,o){e.removeEventListener(t,o)},GL.on(document,"keydown",function(e){if(!e.altKey&&!e.ctrlKey&&!e.metaKey){var t=mapKeyCode(e.keyCode);t&&(GL.keys[t]=!0),GL.keys[e.keyCode]=!0}}),GL.on(document,"keyup",function(e){if(!e.altKey&&!e.ctrlKey&&!e.metaKey){var t=mapKeyCode(e.keyCode);t&&(GL.keys[t]=!1),GL.keys[e.keyCode]=!1}});var ENUM=305397760;